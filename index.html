<!DOCTYPE html>
<html lang="en">
<head>

    <style>

      .diagram-node-location .diagram-node-content {
        background: url(./task.png) no-repeat scroll center transparent;
      }


    </style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <script src="http://cdn.alloyui.com/3.0.1/aui/aui-min.js"></script>
    <link href="http://cdn.alloyui.com/3.0.1/aui-css/css/bootstrap.min.css" rel="stylesheet"></link>
</head>
<body>
    <div id="myDiagramContainer">
      <div id="diagramBuilder" width=100></div>
      <div id="flow chart editor"></div>
      <button id="getJSON">Get JSON</button>
      <button id="loadJSON">Load JSON</button>
    </div>
    <script>


    function click() {

      var field = diagramBuilder.toJSON();
      console.log(JSON.stringify(field));

    }


    YUI({ filter:'raw' }).use('aui-diagram-builder', function(Y) {


    Y.DiagramNodeCustom = Y.Component.create({

        NAME: 'diagram-node',

        ATTRS: {
            type: {
                value: 'location'
            },
            invariant1: {
                validator: Y.Lang.isString,
                value: ''
            },
            invariant2: {
                validator: Y.Lang.isString,
                value: ''
            }
        },

        EXTENDS: Y.DiagramNodeTask,

        prototype: {

        // hotPoints: [[5, 5], [10, 5], [15, 5], [20, 5], [25, 5], [30, 5], [35, 5], [40, 5], [50, 5], [55, 5], [60, 5], [75, 5], [80, 5], [
        //               85, 5], [85, 10], [85, 15], [85, 20], [85, 25], [85, 30], [85, 35], [85, 40], [85, 45], [85, 50], [85,              55], [85, 60], [75, 60], [70, 60], [75, 60], [60, 60], [55, 60], [50, 60], [45, 60], [40, 60], [35, 60], [30, 60], [25, 60], [
        //               20, 60], [15, 60], [10, 60], [5, 60], [5, 55], [5, 50], [5, 45], [5, 40], [5, 35], [5, 30], [5,
        //               25], [5, 20], [5, 15], [5, 10]],

          initializer: function () {
            this.SERIALIZABLE_ATTRS.push('invariant1');
            this.SERIALIZABLE_ATTRS.push('invariant2');

            var instance = this;

            instance.on({
              nameChange: instance._onNameChange,
              invariant1Change: instance._onInvariant1Change,
              invariant2Change: instance._onInvariant2Change
            });
          },


            getPropertyModel: function () {
                var instance = this;

                var model = Y.DiagramNodeTask.superclass.getPropertyModel.apply(instance, arguments);

                var pos = model.map(function(e){return e.name;}).indexOf("Description");

                model.splice(pos, 1);


                var pos = model.map(function(e){return e.name;}).indexOf("Type");

                model.splice(pos, 1);

                model.push({
                    attributeName: 'invariant1',
                    name: 'Invariant1'
                });
                model.push({
                    attributeName: 'invariant2',
                    name: 'Invariant2'
                });

                return model;
            },

          _afterRender: function() {
            var instance = this;

            instance.setStdModContent(Y.WidgetStdMod.BODY, '', Y.WidgetStdMod.AFTER);
            instance._renderGraphic();
            instance._renderControls();
            instance._renderLabel();
            instance._uiSetHighlighted(instance.get('highlighted'));
          },

          _renderLabel: function() {
            var instance = this;

            instance.labelNode = Y.Node.create(
              Y.Lang.sub(instance.LABEL_TEMPLATE, {
                label: (instance.get('name') + "<br>" + instance.get('invariant1') + "<br>" + instance.get('invariant2'))
              })
            );

            //console.log(instance.labelNode.getHTML());

            instance.get('contentBox').prepend(instance.labelNode);
          },

          _uiSetName: function(val) {
            var instance = this;
            var boundingBox = instance.get('boundingBox');

            boundingBox.setAttribute('data-nodeId', Y.Escape.html(Y.DiagramNode.buildNodeId(val)));

            if (instance.get('rendered')) {
              instance.labelNode.setContent(val + "<br>" + instance.get('invariant1') + "<br>" + instance.get('invariant2'));
            }
          },

          _onInvariant1Change: function(event) {
            var instance = this;
            instance.labelNode.setContent(instance.get('name') + "<br>" + event.newVal + "<br>" + instance.get('invariant2'));
          },

          _onInvariant2Change: function(event) {
            var instance = this;
            instance.labelNode.setContent(instance.get('name') + "<br>" + instance.get('invariant1') + "<br>" + event.newVal);
          }


        }
    });

    Y.DiagramBuilder.types['location'] = Y.DiagramNodeCustom;



        var availableFields = [
            {
                iconClass: 'diagram-node-task-icon',
                label: 'Location',
                type: 'location'
            },
            {
              iconClass: 'diagram-node-fork-icon',
              label: 'Fork',
              type: 'fork'
            }
        ];

      var CustomConnector = function() {
      };

      CustomConnector.ATTRS = {
          guard: {
              valueFn: function() {
                  return '';
              }
          }
      };

      CustomConnector.prototype.initializer = function() {
          var instance = this;

          if (instance.SERIALIZABLE_ATTRS.indexOf('guard') == -1)

            instance.SERIALIZABLE_ATTRS.push('guard');

          instance.after({
            nameChange: instance._afterNameChange,
            guardChange: instance._afterGuardChange,
            p1Change: instance.draw,
            p2Change: instance.draw,
            selectedChange: instance._afterSelectedChange,
            showNameChange: instance._afterShowNameChange,
            visibleChange: instance._afterVisibleChange
          });

          instance._uiSetName(instance.get('name') + "<br>" + instance.get('guard'));
      };


      CustomConnector.prototype._afterNameChange = function(event) {

        var instance = this;

        instance._uiSetName(event.newVal + "<br>" + instance.get('guard'));

        console.log(event.newVal);

        instance.draw();

      };

      CustomConnector.prototype._afterGuardChange = function(event) {

        var instance = this;

        instance._uiSetName(instance.get('name') + "<br>" + event.newVal);

        instance.draw();

      };

      CustomConnector.prototype._uiSetName = function(val) {
        var instance = this;

        instance.get('nodeName').html(val);
      };


      CustomConnector.prototype.getPropertyModel = function() {
          var instance = this;

          //console.log(instance);

          return [
            {

              attributeName: 'name',
                  editor: new Y.TextCellEditor(),
                  name: 'Name'
            },

            {
              attributeName: 'guard',
              editor: new Y.TextCellEditor(),
              name: 'Guard'
            }
          ];

          return model;
      };

      Y.Base.mix(Y.Connector, [CustomConnector]);




        var diagramBuilder = new Y.DiagramBuilder({
             availableFields: availableFields,
            boundingBox: '#diagramBuilder',
            connector: CustomConnector,
        }).render();


    Y.one('#getJSON').on(
          'click',

      function (event) {
          console.log('JSON: ' + JSON.stringify(diagramBuilder.toJSON()));
      });


    Y.one('#loadJSON').on(
          'click',

      function (event) {

        var builder = document.getElementById("diagramBuilder");   
        builder.removeChild(builder.childNodes[0]);

        var automata = {};         
        
        var diagramBuilder = new Y.DiagramBuilder({
            availableFields: availableFields,
            boundingBox: '#diagramBuilder',
            connector: CustomConnector,
            fields: [
                {
                    // transitions: [
                    //     'Task1',
                    //     { target: 'Task0' }
                    // ],
                    name: 'Start0',
                    type: 'start',
                    xy: [10, 10]
                },
                {
                    name: 'Condition0',
                    type: 'condition',
                    xy: [100, 100]
                },
                {
                    name: 'State0',
                    type: 'state',
                    xy: [250, 100]
                },
                {
                    name: 'Join0',
                    type: 'join',
                    xy: [100, 300]
                },
                {
                    name: 'Task0',
                    type: 'task',
                    xy: [400, 100]
                },
                {
                    name: 'Fork0',
                    type: 'fork',
                    xy: [400, 300]
                },
                {
                    name: 'EndNode0',
                    type: 'end',
                    xy: [600, 10]
                }
            ],
            render: true
        }).render();

        diagramBuilder.connectAll([
            {
                connector: { name: 'Link0' },
                source: 'Start0',
                target: 'Condition0'
            },
            {
                connector: { name: 'Link1' },
                source: 'Condition0',
                target: 'State0'
            },
            {
                connector: { name: 'Link2' },
                source: 'State0',
                target: 'Join0'
            },
            {
                connector: { name: 'Link3' },
                source: 'Join0',
                target: 'Task0'
            },
            {
                connector: { name: 'Link4' },
                source: 'Task0',
                target: 'Fork0'
            },
            {
                connector: { name: 'Link5' },
                source: 'Fork0',
                target: 'EndNode0'
            },
            {   
                connector: { name: 'Link6' },
                source: 'State0',
                target: 'EndNode0'
            }
        ]);




      });





    });




    </script>
</body>
</html>
