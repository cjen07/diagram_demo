<!DOCTYPE html>
<html lang="en">
<head>

    <style>

      .diagram-node-location .diagram-node-content {
        background: url(./task.png) no-repeat scroll center transparent;
      }


    </style>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <script src="http://cdn.alloyui.com/3.0.1/aui/aui-min.js"></script>
    <link href="http://cdn.alloyui.com/3.0.1/aui-css/css/bootstrap.min.css" rel="stylesheet"></link>
</head>
<body>
    <div id="myDiagramContainer">
      <div id="diagramBuilder" width=100></div>
      <div id="flow chart editor"></div>
      <button id="getJSON">Get JSON</button>
    </div>
    <script>


    function click() {

      var field = diagramBuilder.toJSON();
      console.log(JSON.stringify(field));

    }


    YUI({ filter:'raw' }).use('aui-diagram-builder', function(Y) {


    Y.DiagramNodeCustom = Y.Component.create({

        NAME: 'diagram-node',

        ATTRS: {
            type: {
                value: 'location'
            },
            invariant1: {
                validator: Y.Lang.isString,
                value: ''
            },
            invariant2: {
                validator: Y.Lang.isString,
                value: ''
            }
        },

        EXTENDS: Y.DiagramNodeTask,

        prototype: {

          initializer: function () {
            this.SERIALIZABLE_ATTRS.push('invariant1');
            this.SERIALIZABLE_ATTRS.push('invariant2');

            var instance = this;

            instance.on({
              nameChange: instance._onNameChange,
              invariant1Change: instance._onInvariant1Change,
              invariant2Change: instance._onInvariant2Change
            });


          },


            getPropertyModel: function () {
                var instance = this;

                var model = Y.DiagramNodeTask.superclass.getPropertyModel.apply(instance, arguments);

                var pos = model.map(function(e){return e.name;}).indexOf("Description");

                model.splice(pos, 1);


                var pos = model.map(function(e){return e.name;}).indexOf("Type");

                model.splice(pos, 1);

                model.push({
                    attributeName: 'invariant1',
                    name: 'Invariant1'
                });
                model.push({
                    attributeName: 'invariant2',
                    name: 'Invariant2'
                });

                return model;
            },

          _afterRender: function() {
            var instance = this;

            instance.setStdModContent(Y.WidgetStdMod.BODY, '', Y.WidgetStdMod.AFTER);
            instance._renderGraphic();
            instance._renderControls();
            instance._renderLabel();
            instance._uiSetHighlighted(instance.get('highlighted'));
          },

          _renderLabel: function() {
            var instance = this;

            instance.labelNode = Y.Node.create(
              Y.Lang.sub(instance.LABEL_TEMPLATE, {
                label: (instance.get('name') + "<br>" + instance.get('invariant1') + "<br>" + instance.get('invariant2'))
              })
            );

            //console.log(instance.labelNode.getHTML());

            instance.get('contentBox').placeAfter(instance.labelNode);
          },

          _uiSetName: function(val) {
            var instance = this;
            var boundingBox = instance.get('boundingBox');

            boundingBox.setAttribute('data-nodeId', Y.Escape.html(Y.DiagramNode.buildNodeId(val)));

            if (instance.get('rendered')) {
              instance.labelNode.setContent(val + "<br>" + instance.get('invariant1') + "<br>" + instance.get('invariant2'));
            }
          },

          _onInvariant1Change: function(event) {
            var instance = this;
            instance.labelNode.setContent(instance.get('name') + "<br>" + event.newVal + "<br>" + instance.get('invariant2'));
          },

          _onInvariant2Change: function(event) {
            var instance = this;
            instance.labelNode.setContent(instance.get('name') + "<br>" + instance.get('invariant1') + "<br>" + event.newVal);
          }


        }
    });

    Y.DiagramBuilder.types['location'] = Y.DiagramNodeCustom;



        var availableFields = [
            {
                iconClass: 'diagram-node-task-icon',
                label: 'Location',
                type: 'location'
            },
            {
              iconClass: 'diagram-node-fork-icon',
              label: 'Fork',
              type: 'fork'
            }
        ];

      var CustomConnector = function() {
      };

      CustomConnector.ATTRS = {
          guard: {
              valueFn: function() {
                  return '';
              }
          }
      };

      CustomConnector.prototype.initializer = function() {
          var instance = this;

          if (instance.SERIALIZABLE_ATTRS.indexOf('guard') == -1)

            instance.SERIALIZABLE_ATTRS.push('guard');

          instance.after({
            nameChange: instance._afterNameChange,
            guardChange: instance._afterGuardChange,
            p1Change: instance.draw,
            p2Change: instance.draw,
            selectedChange: instance._afterSelectedChange,
            showNameChange: instance._afterShowNameChange,
            visibleChange: instance._afterVisibleChange
          });

          instance._uiSetName(instance.get('name') + "<br>" + instance.get('guard'));
      };


      CustomConnector.prototype._afterNameChange = function(event) {

        var instance = this;

        instance._uiSetName(event.newVal + "<br>" + instance.get('guard'));

        console.log(event.newVal);

        instance.draw();

      };

      CustomConnector.prototype._afterGuardChange = function(event) {

        var instance = this;

        instance._uiSetName(instance.get('name') + "<br>" + event.newVal);

        instance.draw();

      };

      CustomConnector.prototype._uiSetName = function(val) {
        var instance = this;

        instance.get('nodeName').html(val);
      };


      CustomConnector.prototype.getPropertyModel = function() {
          var instance = this;

          //console.log(instance);

          return [
            {

              attributeName: 'name',
                  editor: new Y.TextCellEditor(),
                  name: 'Name'
            },

            {
              attributeName: 'guard',
              editor: new Y.TextCellEditor(),
              name: 'Guard'
            }
          ];

          return model;
      };

      Y.Base.mix(Y.Connector, [CustomConnector]);




        var diagramBuilder = new Y.DiagramBuilder({
            availableFields: availableFields,
            boundingBox: '#diagramBuilder',
            connector: CustomConnector,
        }).render();


    Y.one('#getJSON').on(
          'click',

      function (event) {
          console.log('JSON: ' + JSON.stringify(diagramBuilder.toJSON()));
      });




    });
    </script>
</body>
</html>
